<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <title>SocketIO Client</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://aframe.io/releases/0.7.0/aframe.min.js"></script>
  </head>
  <body>

    <!-- File input and image output -->
    <button type="button" id="input" style="width: 100%; height:10%">Test Me </button>
    <div>
      <button type="button" id="x" onclick="setDim('x')"> X </button>
      <button type="button" id="y" onclick="setDim('y')"> Y </button>
      <button type="button" id="z" onclick="setDim('z')"> Z </button>
    </div>
    <button type="button" id="start" style="width: 100%; height:10%">Start </button>
    <button type="button" id="stop" style="width: 100%; height:10%">Stop </button>

    <a-scene>
      <a-box id="box" position="-1 0.5 -3" rotation="0 45 0" color="#4CC3D9" shadow></a-box>
      <a-sphere id="sphere" position="0 1.25 -5" radius="1.25" color="#EF2D5E" shadow></a-sphere>
      <a-cylinder id="cylinder" position="1 0.75 -3" radius="0.5" height="1.5" color="#FFC65D" shadow></a-cylinder>
      <a-plane id="plane" position="0 0 -4" rotation="-90 0 0" width="4" height="4" color="#7BC8A4" shadow></a-plane>
      <a-sky id="sky" color="#ECECEC"></a-sky>
    </a-scene>

    <!-- Client Code -->
    <script type="text/javascript">
      var deviceorientation;
      var deviceorientation_start;
      var deviceorientation_delta;
      var dim = 'x';
      // Get WebSocket
      var socket = io();
      // Join a channel
      var room = "test";
      socket.emit("join", room);

      window.addEventListener("deviceorientation", function(event) {
        switch(dim) {
          case 'x': deviceorientation = event.beta
          case 'y': deviceorientation = event.gamma
          case 'z': deviceorientation = event.alpha
        }
      });
      // Listen to file input events
      document.getElementById("input").addEventListener("click", function (event) {
        // Prepeare file reader
          var msg = "Test";
          socket.emit("test", msg);
      })
      document.getElementById("start").addEventListener("click", function (event) {
        // Prepeare file reader
          deviceorientation_start = deviceorientation;
          console.log("started");
      })
      document.getElementById("stop").addEventListener("click", function (event) {
        // Prepeare file reader
          deviceorientation_delta = deviceorientation - deviceorientation_start;
          var msg = {
            delta: deviceorientation_delta,
            dimension: dim,
          };
          socket.emit("orientation", msg);
      })

      socket.on("test", function (msg) {
        console.log(msg);
      });

      socket.on("orientation", function (msg) {
        console.log(msg);
        change({element: "box", attr: "rotation", dim: "x" , value: msg.delta});
      });

      function setDim(value) {
        console.log(value);
        dim = value;
      }

      function change (payload) {
        var current_attr_value = {};
        current_attr_value = document.getElementById(payload.element).getAttribute(payload.attr);
        current_attr_value[payload.dim] = current_attr_value[payload.dim] + parseFloat(payload.value);
        document.getElementById(payload.element).setAttribute(payload.attr, current_attr_value);
      }
    </script>
  </body>
</html>
