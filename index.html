<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <title>SocketIO Client</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://aframe.io/releases/0.7.0/aframe.min.js"></script>
  </head>
  <body>
    <button type="button" id="input" style="width: 100%; height:10%">Test Me </button>
    <!-- <button type="button" id="cameraButton" style="width: 100%; height:10%">Camera Change</button> -->
    <div style="height:10%">
      <button type="button" id="rotate" style="width: 45%; height:100%" ontouchstart="startTransform(event, 'rotate')" ontouchend="endTransform(event)">Rotate </button>
      <button type="button" id="translate" style="width: 45%; height:100%" ontouchstart="startTransform(event, 'translate')" ontouchend="endTransform(event)">Translate </button>
    </div>

    <a-scene>
      <a-box id="box" position="-1 0.5 -3" rotation="0 45 0" color="#4CC3D9" shadow></a-box>
      <a-sphere id="sphere" position="0 1.25 -5" radius="1.25" color="#EF2D5E" shadow></a-sphere>
      <a-cylinder id="cylinder" position="1 0.75 -3" radius="0.5" height="1.5" color="#FFC65D" shadow></a-cylinder>
      <a-plane id="plane" position="0 0 -4" rotation="-90 0 0" width="4" height="4" color="#7BC8A4" shadow></a-plane>
      <a-sky id="sky" color="#ECECEC"></a-sky>
      <a-entity position="0 0 20">
        <a-camera id="camera"></a-camera>
      </a-entity>
      <a-camera id="camera2"></a-camera>
    </a-scene>

    <!-- Client Code -->
    <script type="text/javascript">
      var deviceorientation = {};
      var deviceorientation_start = {};
      var deviceorientation_delta = {};

      var acceleration_sum;
      var time_seconds;
      var avg_acceleration;
      var devicemotion = {};

      var speed_sum;
      var avg_speed;
      var devicespeed = {};

      var transform_type = "rotate"; //default behaviour
      var dim = 'x';

      var data_being_sent;
      var acceleration_being_sum;
      var speed_being_sum;

      var lastTimestamp;

      // Get WebSocket
      var socket = io();
      // Join a channel
      var room = "test";
      socket.emit("join", room);

      window.addEventListener("devicemotion", function (event) {
        devicemotion.x = event.acceleration.x;
        devicemotion.y = event.acceleration.y;
        devicemotion.z = event.acceleration.z;
        var currentTime = new Date().getTime();
        if (lastTimestamp === undefined) {
          lastTimestamp = new Date().getTime();
          return; //ignore first call, we need a reference time
        }
        //  m/sÂ² * (miliseconds - miliseconds)/1000  => m/s
        devicespeed.x += event.acceleration.x  * ((currentTime - lastTimestamp)/1000);
        devicespeed.y += event.acceleration.y  * ((currentTime - lastTimestamp)/1000);
        devicespeed.z += event.acceleration.z  * ((currentTime - lastTimestamp)/1000);

        lastTimestamp = currentTime;
      });

      window.addEventListener("deviceorientation", function(event) {
        deviceorientation = {
          x: event.beta,
          y: event.gamma,
          z: event.alpha
        }
      });

      document.getElementById("input").addEventListener("click", function (event) {
          var msg = "Test";
          socket.emit("test", msg);
      })

      // document.getElementById("cameraButton").addEventListener("click", function (event) {
      //     var msg = {
      //       id: 'camera'
      //     };
      //     socket.emit("cameraChange", msg);
      // })

      socket.on("test", function (msg) {
        console.log(msg);
      });

      socket.on("orientation", function (msg) {
        console.log(msg);
        switch (msg.transform) {
          case "rotate":
            change({element: "box", attr: "rotation", dim: msg.dimension , value: msg.delta}); break;
          case "translate":
            change({element: "box", attr: "position", dim: 'x', value: msg.speed_sum*10}); break;
        }

      });

      socket.on("cameraChange", function (msg) {
        console.log(msg);
        document.getElementById(msg.id).setAttribute('camera', 'active', true);
      });

      function startTransform (event, type) {
        event.preventDefault();
        transform_type = type;
        deviceorientation_start = deviceorientation;
        //acceleration_sum = devicemotion.x;
        speed_sum = devicespeed.x;
        time_seconds = 0; //Initiatlize
        speed_being_sum = setInterval(add, 11);
        data_being_sent = setInterval(sendData, 50);

      //  acceleration_being_sum = setInterval(add, 11);

      }

      function endTransform (event) {
        event.preventDefault();
        clearTimeout(data_being_sent);
        //clearTimeout(acceleration_being_sum);
        clearTimeout(speed_being_sum);
      }

      function setDim(value) {
        dim = value;
      }

      function change (payload) {
        var current_attr_value = {};
        current_attr_value = document.getElementById(payload.element).getAttribute(payload.attr);
        current_attr_value[payload.dim] = current_attr_value[payload.dim] + parseFloat(payload.value);
        document.getElementById(payload.element).setAttribute(payload.attr, current_attr_value);
      }

      function changeCamera (id) {
        document.getElementById(id).setAttribute("active", "true");
      }

      function add() {
          //console.log(devicemotion.x);
          //acceleration_sum = acceleration_sum + Math.abs(devicemotion.x);
          speed_sum = speed_sum + devicespeed.x;
          time_seconds = time_seconds + 11; //in milliseconds to not coincide with 50
      }

      function sendData () {
        deviceorientation_delta = {
          x: deviceorientation.x - deviceorientation_start.x,
          y: deviceorientation.y - deviceorientation_start.y,
          z: deviceorientation.z - deviceorientation_start.z,
        }
        var max_delta = Math.max(deviceorientation_delta.x, deviceorientation_delta.y, deviceorientation_delta.z);
        var max_delta_dim = Object.keys(deviceorientation_delta).find(key => deviceorientation_delta[key] === max_delta);
        //avg_acceleration = acceleration_sum/time_seconds;
        //acceleration_sum = devicemotion.x;

        var msg = {
          delta: max_delta,
          dimension: max_delta_dim,
          transform: transform_type,
          avg_distance: speed_sum,
        };

        socket.emit("orientation", msg);
        speed_sum = devicespeed.x;
        time_seconds = 0;
        deviceorientation_start = deviceorientation; //reset
      }
    </script>
  </body>
</html>
